#!/bin/bash

############################################################
#### author: SlickStack ####################################
#### link: https://slickstack.io ###########################
#### mirror: http://mirrors.slickstack.io/ss-worker.txt ####
#### path: /var/www/ss-worker ##############################
#### destination: n/a ######################################
#### purpose: performs various maintenance tasks ###########
############################################################

## slickstack config ##
source /var/www/ss-config

#########################################
#### update various slickstack files ####
#########################################

## delete tmp files ##
rm -R -f /tmp/1-cron-often.txt* /tmp/1-cron-often*
rm -R -f /tmp/ss-check.txt* /tmp/ss-check*
# rm -R -f /tmp/gai-conf.txt* /tmp/gai.conf*

# download latest versions ##
cd /tmp/
wget --no-cache http://mirrors.slickstack.io/1-cron-often.txt
wget --no-cache http://mirrors.slickstack.io/ss-check.txt
# wget --no-cache http://mirrors.slickstack.io/ubuntu/gai-conf.txt

## rename files ##
cd /tmp/
mv 1-cron-often.txt 1-cron-often
mv ss-check.txt ss-check
# mv gai-conf.txt gai.conf

## copy files to their destinations ##
cp -R -f -d --no-preserve=mode,ownership /tmp/1-cron-often /var/www/1-cron-often
cp -R -f -d --no-preserve=mode,ownership /tmp/ss-check /var/www/ss-check
# cp -R -f -d --no-preserve=mode,ownership /tmp/gai.conf /etc/gai.conf

## delete tmp files ##
rm -R -f /tmp/1-cron-often.txt* /tmp/1-cron-often*
rm -R -f /tmp/ss-check.txt* /tmp/ss-check*
rm -R -f /tmp/gai-conf.txt* /tmp/gai.conf*

## reset permissions ##
chown root:root /var/www/1-cron-often
chmod -R 700 /var/www/1-cron-often
chown root:root /var/www/ss-check
chmod -R 700 /var/www/ss-check
# chown root:root /etc/gai.conf

## update plugin blacklist ##
rm -R -f /tmp/blacklist*
cd /tmp/
wget --no-cache http://mirrors.slickstack.io/wordpress/blacklist.txt
rm -R -f /var/www/html/wp-content/blacklist.txt
cp -f -d --no-preserve=mode,ownership /tmp/blacklist.txt /var/www/html/wp-content/blacklist.txt
rm -R -f /tmp/blacklist*
chown www-data:wordpress /var/www/html/wp-content/blacklist.txt
chmod 664 /var/www/html/wp-content/blacklist.txt

############################
#### various TEMP tasks ####
############################

## TEMP change error log path ##
# sed -i '/error_log/c\error_log = /var/www/logs/error.log' /etc/php/7.2/fpm/php-fpm.conf
# sed -i "s#/var/log/php-fpm/error.log#/var/www/logs/error.log#g" /var/www/html/wp-config.php

## TEMP restart services ##
# /etc/init.d/nginx restart

#############################
#### configure wordpress ####
#############################

## delete tmp files ##
rm -R -f /tmp/wp-config*

## download latest versions ##
cd /tmp/
wget --no-cache http://mirrors.slickstack.io/wordpress/wp-config.txt

## replace placeholders with variables ##
sed -i "s/@DBNAME/${dbname}/g" /tmp/wp-config.txt
sed -i "s/@DBUSER/${dbuser}/g" /tmp/wp-config.txt
sed -i "s/@DBPASSWORD/${dbuserpass}/g" /tmp/wp-config.txt
sed -i "s/@DBNAME/${dbname}/g" /tmp/wp-config.txt
sed -i "s/@TABLEPREFIX/${dbprefix}/g" /tmp/wp-config.txt
# sed -i "s/@DBHOST/${dbhost}/g" /tmp/wp-config.txt
# sed -i "s/@DBCHARSET/${dbcharset}/g" /tmp/wp-config.txt
# sed -i "s/@DBCOLLATE/${dbcollate}/g" /tmp/wp-config.txt

## replace sftp details placeholders ##
sed -i "s/@SFTPDETAILSSERVER/${userserver}/g" /tmp/wp-config.txt
sed -i "s/@SFTPDETAILSUSER/${user}/g" /tmp/wp-config.txt
sed -i "s/@SFTPDETAILSPASSWORD/${userpass}/g" /tmp/wp-config.txt
sed -i "s/@SFTPDETAILSPORT/${userport}/g" /tmp/wp-config.txt
sed -i "s#@SFTPDETAILSROOT#${userroot}#g" /tmp/wp-config.txt
sed -i "s#@SFTPDETAILSPUBLIC#${userpublic}#g" /tmp/wp-config.txt

## replace cloudflare placeholders ##
sed -i "s/@CLOUDFLAREAPIKEY/${cloudflareapikey}/g" /tmp/wp-config.txt
sed -i "s/@CLOUDFLAREAPIEMAIL/${cloudflareapiemail}/g" /tmp/wp-config.txt

## replace salt keys ##
sed -i "s/@AUTHKEY/$(openssl rand -hex 48)/g" /tmp/wp-config.txt
sed -i "s/@SECUREAUTHKEY/$(openssl rand -hex 48)/g" /tmp/wp-config.txt
sed -i "s/@LOGGEDINKEY/$(openssl rand -hex 48)/g" /tmp/wp-config.txt
sed -i "s/@NONCEKEY/$(openssl rand -hex 48)/g" /tmp/wp-config.txt
sed -i "s/@AUTHSALT/$(openssl rand -hex 48)/g" /tmp/wp-config.txt
sed -i "s/@SECUREAUTHSALT/$(openssl rand -hex 48)/g" /tmp/wp-config.txt
sed -i "s/@LOGGEDINSALT/$(openssl rand -hex 48)/g" /tmp/wp-config.txt
sed -i "s/@NONCESALT/$(openssl rand -hex 48)/g" /tmp/wp-config.txt

## replace debug placeholers ##
if [[ "$production" == "yes" ]]
then sed -i "s/@DEBUGON/false/g" /tmp/wp-config.txt
else sed -i "s/@DEBUGON/true/g" /tmp/wp-config.txt
fi

## replace debug placeholers ##
# if [[ "$production" == "yes" ]]
# then sed -i "s/@DEBUGLOG/false/g" /tmp/wp-config.txt
# else sed -i "s/@DEBUGLOG/true/g" /tmp/wp-config.txt
# fi

## replace debug placeholers ##
if [[ "$production" == "yes" ]]
then sed -i "s/@DEBUGDISPLAY/false/g" /tmp/wp-config.txt
else sed -i "s/@DEBUGDISPLAY/true/g" /tmp/wp-config.txt
fi

## rename files ##
mv /tmp/wp-config.txt /tmp/wp-config.php

## backup old wp-config if not already ##
cp -n /var/www/html/wp-config.php /var/www/html/wp-config.bak-23-jan-2019

## copy files to destinations ##
cp -R -f --no-preserve=mode,ownership /tmp/wp-config.php /var/www/html/wp-config.php

## delete tmp files ##
rm -R -f /tmp/wp-config*
